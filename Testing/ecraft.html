// --- DOM Elements ---
const inventorySlots = document.querySelectorAll('.inventory-slot[data-product]');
const tooltip = document.getElementById('item-tooltip');
const tabs = document.querySelectorAll('.inventory-tab');
const pcGrid = document.getElementById('pc-grid');
const modalOverlay = document.getElementById('product-modal');
const modalImage = document.getElementById('modal-image');
const modalTitle = document.getElementById('modal-title');
const modalSpecs = document.getElementById('modal-specs');
const modalEnch = document.getElementById('modal-ench');
const modalPrice = document.getElementById('modal-price');
const modalBuyButton = document.getElementById('modal-buy-button');
const modalCloseButton = document.getElementById('modal-close-button');
const navLinks = document.querySelectorAll('.site-navigation .nav-slot a');
const navSlots = document.querySelectorAll('.site-navigation .nav-slot');
const inventoryTitle = document.querySelector('.inventory-title'); // Get the title element


// --- Product Data ---
// !! Make sure your productData is complete and correct here !!
const productData = {
   "gaming-diamond": { name: "Diamond Gaming PC + Minecraft Decal Bundle", icon: "icon-diamond", imageSrc: "https://via.placeholder.com/230/4BDDBE/FFFFFF?text=Diamond+PC+Large", category: ["gaming"], price: "$1999", specs: ["GeForce RTX 5080", "32GB DDR5 RAM", "2TB NVMe SSD", "Liquid Cooled CPU"], ench: "Prismarine RGB Lighting", shopifyUrl: "https://www.google.com" },
   "workstation-netherite": { name: "Netherite Workstation + Minecraft Decal Bundle", icon: "icon-netherite", imageSrc: "https://via.placeholder.com/230/404040/FFFFFF?text=Netherite+WS+Large", category: ["workstation"], price: "$2999", specs: ["GeForce RTX 5090", "64GB DDR5 RAM", "4TB NVMe SSD", "AMD Threadripper Pro"], ench: "Unbreaking Durability Build", shopifyUrl: "https://www.google.com" },
   "budget-iron": { name: "Iron Budget Tower + Minecraft Decal Bundle", icon: "icon-iron", imageSrc: "https://via.placeholder.com/230/C1C5C5/000000?text=Iron+PC+Large", category: ["budget", "gaming"], price: "$999", specs: ["GeForce RTX 4060", "16GB DDR4 RAM", "1TB NVMe SSD", "Intel Core i5"], shopifyUrl: "https://www.google.com" },
   "streaming-emerald": { name: "Emerald Stream Rig + Minecraft Decal Bundle", icon: "icon-emerald", imageSrc: "https://via.placeholder.com/230/009940/FFFFFF?text=Emerald+Rig+Large", category: ["gaming", "workstation"], price: "$1699", specs: ["GeForce RTX 5070", "32GB DDR5 RAM", "2TB NVMe SSD", "Ryzen 7 CPU"], ench: "Built-in Capture Card", shopifyUrl: "https://www.google.com" },
   "mini-redstone": { name: "Redstone Mini PC + Minecraft Decal Bundle", icon: "icon-redstone", imageSrc: "https://via.placeholder.com/230/C80000/FFFFFF?text=Redstone+Mini+Large", category: ["budget", "custom"], price: "$799", specs: ["GeForce RTX 4050", "16GB DDR4 RAM", "1TB NVMe SSD", "Compact ITX Case"], shopifyUrl: "https://www.google.com" },
   "highend-gold": { name: "Gilded Elite PC + Minecraft Decal Bundle", icon: "icon-gold", imageSrc: "https://via.placeholder.com/230/FFD700/000000?text=Gold+Elite+Large", category: ["gaming", "workstation"], price: "$3499", specs: ["GeForce RTX 5090 Ti", "128GB DDR5 RAM", "8TB NVMe SSD (RAID)", "Intel Core i9 Extreme"], ench: "Custom Gold-Accent Cooling", shopifyUrl: "https://www.google.com" },
   "budget-wood": { name: "Oak Starter PC + Minecraft Decal Bundle", icon: "icon-wood", imageSrc: "https://via.placeholder.com/230/A37B4A/FFFFFF?text=Oak+Starter+Large", category: ["budget"], price: "$599", specs: ["Integrated AMD Graphics", "16GB DDR4 RAM", "512GB SATA SSD", "Ryzen 5 APU"], shopifyUrl: "https://www.google.com" },
   "mouse-pro": { name: "Diamond Pro Mouse + Minecraft Decal Bundle", imageSrc: 'https://via.placeholder.com/230/CCCCCC/000000?text=Pro+Mouse+Large', category: ["peripheral"], price: "$79", specs: ["16,000 DPI Sensor", "5 Programmable Buttons", "RGB Illumination", "Lightweight Design"], shopifyUrl: "https://www.google.com" },
   "keyboard-mech": { name: "Netherite Mech Keyboard + Minecraft Decal Bundle", imageSrc: 'https://via.placeholder.com/230/333333/FFFFFF?text=Mech+KB+Large', category: ["peripheral"], price: "$129", specs: ["Hot-swappable Switches", "Per-Key RGB", "N-Key Rollover", "Aluminum Plate"], ench: "Sound Dampening Foam", shopifyUrl: "https://www.google.com" },
};

// --- Helper Function ---
 function isMobile() {
     return window.innerWidth <= 768;
 }

// --- Tooltip Logic ---
function positionTooltip(e) {
    if (!tooltip) return; // Safety check
    const tooltipWidth = tooltip.offsetWidth;
    const tooltipHeight = tooltip.offsetHeight;
    const margin = 15; let left = e.pageX + margin; let top = e.pageY + margin;
    if (left + tooltipWidth > window.innerWidth + window.scrollX - margin) { left = e.pageX - tooltipWidth - margin; }
    if (top + tooltipHeight > window.innerHeight + window.scrollY - margin) { top = e.pageY - tooltipHeight - margin; }
    if (left < window.scrollX + margin) left = window.scrollX + margin;
    if (top < window.scrollY + margin) top = window.scrollY + margin;
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
}

// --- Modal Logic ---
function openModal(productId) {
    const data = productData[productId];
    if (!data || !modalOverlay || !modalTitle || !modalPrice || !modalImage || !modalSpecs || !modalEnch || !modalBuyButton) return; // Safety checks

    modalTitle.textContent = data.name;
    modalPrice.textContent = data.price;

    modalImage.innerHTML = '';
    if (data.imageSrc) {
        const img = document.createElement('img');
        img.src = data.imageSrc;
        img.alt = data.name;
        modalImage.appendChild(img);
    } else if (data.icon) {
         const iconDiv = document.createElement('div');
         iconDiv.className = `item-icon ${data.icon}`;
         iconDiv.style.width = '80%';
         iconDiv.style.height = '80%';
         modalImage.appendChild(iconDiv);
    } else {
         modalImage.innerHTML = '<p style="color: #555;">No Image</p>';
    }

    let specsHtml = data.specs ? '<ul>' + data.specs.map(s => `<li>${s}</li>`).join('') + '</ul>' : '<p>Details not available.</p>';
    modalSpecs.innerHTML = specsHtml;

    modalEnch.innerHTML = data.ench ? `${data.ench}` : '';
    modalEnch.style.display = data.ench ? 'block' : 'none';

    modalBuyButton.href = data.shopifyUrl || '#';
    if (!data.shopifyUrl) {
        modalBuyButton.style.opacity = '0.5';
        modalBuyButton.style.pointerEvents = 'none';
        modalBuyButton.textContent = 'Unavailable';
    } else {
         modalBuyButton.style.opacity = '1';
         modalBuyButton.style.pointerEvents = 'auto';
         modalBuyButton.textContent = 'Buy Now';
    }
    modalOverlay.classList.add('active');
}

function closeModal() {
    if (modalOverlay) modalOverlay.classList.remove('active');
}

// --- Filter Function ---
function filterItems(selectedCategory) {
    inventorySlots.forEach(slot => {
        const productId = slot.getAttribute('data-product');
        // Check if product exists in data before accessing category
        const productInfo = productData[productId];
        const itemCategories = productInfo?.category || [];
        const matches = selectedCategory === 'all' || itemCategories.includes(selectedCategory);
        slot.style.display = matches ? 'flex' : 'none';
    });
}

// --- Event Listeners ---

// Inventory Slots (Tooltip and Modal Trigger)
inventorySlots.forEach(slot => {
    const productId = slot.getAttribute('data-product');
    if (!productData[productId]) return; // Skip if product data missing

    slot.addEventListener('mouseenter', (e) => {
         if (isMobile()) return;
         const data = productData[productId];
         if (!data || !tooltip) return;
         let specsHtml = data.specs ? '<ul>' + data.specs.map(s => `<li>${s}</li>`).join('') + '</ul>' : '';
         let enchHtml = data.ench ? `<div class="tooltip-ench">${data.ench}</div>` : '';
         tooltip.innerHTML = `<div class="tooltip-name">${data.name}</div><div class="tooltip-specs">${specsHtml}</div>${enchHtml}<div class="tooltip-price">${data.price}</div>`;
         tooltip.style.display = 'block';
         positionTooltip(e);
    });
    slot.addEventListener('mousemove', (e) => {
         if (isMobile() || !tooltip || tooltip.style.display !== 'block') return;
         positionTooltip(e);
     });
    slot.addEventListener('mouseleave', () => {
         if (isMobile() || !tooltip) return;
         tooltip.style.display = 'none';
     });

    slot.addEventListener('click', () => {
        openModal(productId);
    });
});

// Modal Closing
if (modalCloseButton) modalCloseButton.addEventListener('click', closeModal);
if (modalOverlay) modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) {
        closeModal();
    }
});

// Sidebar Tab Filtering (Handles Desktop)
tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        const selectedCategory = tab.getAttribute('data-category');
        // Use text content of the tab for the title, fallback to category name
        const categoryTitle = tab.textContent.trim().split('\n')[0] || selectedCategory; // Get text before icon/newline

        // Update active state for sidebar tabs
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

         // Update active state for hotbar slots
         navSlots.forEach(navSlot => {
             const link = navSlot.querySelector('a');
             if (link && link.getAttribute('data-category') === selectedCategory) {
                 navSlot.classList.add('selected');
             } else {
                 navSlot.classList.remove('selected');
             }
         });

         // Update Inventory Title
         if (inventoryTitle) {
            inventoryTitle.textContent = categoryTitle;
         }

        // Apply the filter
        filterItems(selectedCategory);
    });
});

 // Hotbar Navigation Filtering (Handles Mobile and Desktop Clicks)
 navLinks.forEach(link => {
     link.addEventListener('click', (e) => {
         e.preventDefault(); // Prevent default anchor behavior
         const selectedCategory = link.getAttribute('data-category');
         const parentSlot = link.closest('.nav-slot');
         const categoryTitle = link.getAttribute('title') || selectedCategory; // Use link title

         // 1. Update Hotbar Visual Selection
         navSlots.forEach(s => s.classList.remove('selected'));
         if (parentSlot) {
             parentSlot.classList.add('selected');
         }

         // 2. Update Inventory Title
         if (inventoryTitle) {
            inventoryTitle.textContent = categoryTitle;
         }

         // 3. Filter Grid Items
         filterItems(selectedCategory);

         // 4. (Desktop) Update Sidebar Tab Selection Visually if sidebar exists
         const targetTab = document.querySelector(`.inventory-tab[data-category="${selectedCategory}"]`);
         if(targetTab && !isMobile()) { // Only sync sidebar if visible
             tabs.forEach(t => t.classList.remove('active'));
             targetTab.classList.add('active');
         }
     });
 });


// --- Initialisation ---
// Trigger the click on the initially active *hotbar* slot on page load
// This ensures filtering and title are set correctly regardless of mobile/desktop
document.querySelector('.site-navigation .nav-slot.selected a')?.click();
// Fallback if no hotbar slot is initially selected (shouldn't happen with default HTML)
if (!document.querySelector('.site-navigation .nav-slot.selected a')) {
    document.querySelector('.site-navigation .nav-slot a[data-category="all"]')?.click();
}


</script>

</body>
</html>